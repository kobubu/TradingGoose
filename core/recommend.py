"""recommend.py Core module for the Telegram stock forecast bot."""
import os

# --- thresholds & config ---

MIN_PROFIT_PCT = float(os.getenv("MIN_PROFIT_PCT", "0.015"))
MIN_PROFIT_USD = float(os.getenv("MIN_PROFIT_USD", "3.0"))
RMSE_MULTIPLIER = float(os.getenv("RMSE_MULTIPLIER", "0.7"))

TREND_ALERT_PCT = float(os.getenv("TREND_ALERT_PCT", "5.0"))  # 5% –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

# –ü–æ—Ä–æ–≥ –¥–ª—è –±–æ–ª–µ–µ "–∂—ë—Å—Ç–∫–æ–π" –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
POSITION_STRONG_TREND_PCT = float(os.getenv("POSITION_STRONG_TREND_PCT", "7.5"))
POSITION_WEAK_TREND_PCT = float(os.getenv("POSITION_WEAK_TREND_PCT", "3.0"))

UP_EMOJI = "üî¥üìâ"    # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∫–∞–∫ "–ø—Ä–æ–¥–∞–∂–∞"
DOWN_EMOJI = "üü¢üìà"  # –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∫–∞–∫ "–ø–æ–∫—É–ø–∫–∞"


# --------------------------------------------------------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# --------------------------------------------------------------------

def _local_extrema(series):
    """–ù–∞—Ö–æ–¥–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–∏–Ω–∏–º—É–º—ã –∏ –º–∞–∫—Å–∏–º—É–º—ã –≤ –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ä—è–¥—É."""
    idx = series.index
    vals = series.values
    mins, maxs = [], []
    for i in range(1, len(vals) - 1):
        if vals[i] < vals[i - 1] and vals[i] < vals[i + 1]:
            mins.append(idx[i])
        if vals[i] > vals[i - 1] and vals[i] > vals[i + 1]:
            maxs.append(idx[i])
    return mins, maxs


def _build_long_trades(s, mins, maxs, capital_usd, model_rmse):
    """–°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–∫—É–ø–∫–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–∏–Ω–∏–º—É–º–∞—Ö, –ø—Ä–æ–¥–∞–∂–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö –º–∞–∫—Å–∏–º—É–º–∞—Ö."""
    trades = []
    local_maxs = list(maxs)  # –∫–æ–ø–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ä—Ç–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫
    i = 0
    while i < len(mins):
        buy_day = mins[i]
        sell_candidates = [m for m in local_maxs if m > buy_day]
        if not sell_candidates:
            break
        sell_day = sell_candidates[0]
        trades.append((buy_day, sell_day))
        # —É–¥–∞–ª—è–µ–º –≤—Å–µ –º–∞–∫—Å–∏–º—É–º—ã –¥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
        local_maxs = [m for m in local_maxs if m > sell_day]
        i += 1

    profit = 0.0
    lines = []
    markers = []

    # RMSE-–ø–æ—Ä–æ–≥
    rmse_req = 0.0
    try:
        if model_rmse is not None:
            rmse_req = float(model_rmse) * float(RMSE_MULTIPLIER)
    except Exception:
        rmse_req = 0.0

    min_required = max(MIN_PROFIT_USD, capital_usd * MIN_PROFIT_PCT, rmse_req)

    for buy, sell in trades:
        buy_price = float(s.loc[buy])
        sell_price = float(s.loc[sell])
        if sell_price <= buy_price:
            continue

        shares = capital_usd / buy_price
        pnl = shares * (sell_price - buy_price)
        if pnl < min_required:
            continue

        profit += pnl
        lines.append(
            f"–õ–æ–Ω–≥ ‚Äî –ø–æ–∫—É–ø–∞—Ç—å {DOWN_EMOJI}: {buy.date()} @ {buy_price:.2f} ‚Üí "
            f"–ø—Ä–æ–¥–∞–≤–∞—Ç—å {UP_EMOJI}: {sell.date()} @ {sell_price:.2f} "
            f"(–¥–æ—Ö–æ–¥ ~ {pnl:.2f} USD)"
        )
        markers.append(
            {
                "side": "long",
                "buy": buy,
                "sell": sell,
                "buy_price": buy_price,
                "sell_price": sell_price,
                "pnl": pnl,
            }
        )

    return profit, lines, markers


def _build_short_trades(s, mins, maxs, capital_usd, model_rmse):
    """–°—Ü–µ–Ω–∞—Ä–∏–π: —à–æ—Ä—Ç ‚Äî –ø—Ä–æ–¥–∞–∂–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –º–∞–∫—Å–∏–º—É–º–∞—Ö, –∑–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏—Ö –º–∏–Ω–∏–º—É–º–∞—Ö."""
    trades = []
    local_mins = list(mins)
    i = 0
    while i < len(maxs):
        sell_day = maxs[i]  # –æ—Ç–∫—Ä—ã–≤–∞–µ–º —à–æ—Ä—Ç –Ω–∞ –º–∞–∫—Å–∏–º—É–º–µ
        cover_candidates = [m for m in local_mins if m > sell_day]
        if not cover_candidates:
            break
        cover_day = cover_candidates[0]  # –∑–∞–∫—Ä—ã–≤–∞–µ–º —à–æ—Ä—Ç –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–º –º–∏–Ω–∏–º—É–º–µ
        trades.append((sell_day, cover_day))
        local_mins = [m for m in local_mins if m > cover_day]
        i += 1

    profit = 0.0
    lines = []
    markers = []

    # RMSE-–ø–æ—Ä–æ–≥
    rmse_req = 0.0
    try:
        if model_rmse is not None:
            rmse_req = float(model_rmse) * float(RMSE_MULTIPLIER)
    except Exception:
        rmse_req = 0.0

    min_required = max(MIN_PROFIT_USD, capital_usd * MIN_PROFIT_PCT, rmse_req)

    for sell, cover in trades:
        sell_price = float(s.loc[sell])
        cover_price = float(s.loc[cover])
        if cover_price >= sell_price:
            continue  # —à–æ—Ä—Ç –Ω–µ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª–∞, –µ—Å–ª–∏ —Ü–µ–Ω–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç

        # —Ä–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏: —Å–∫–æ–ª—å–∫–æ –∞–∫—Ü–∏–π –º–æ–∂–Ω–æ "–ø—Ä–æ–¥–∞—Ç—å" –Ω–∞ –¥–∞–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª
        shares = capital_usd / sell_price
        pnl = shares * (sell_price - cover_price)
        if pnl < min_required:
            continue

        profit += pnl
        lines.append(
            f"–®–æ—Ä—Ç ‚Äî –ø—Ä–æ–¥–∞–≤–∞—Ç—å {UP_EMOJI}: {sell.date()} @ {sell_price:.2f} ‚Üí "
            f"–ø–æ–∫—É–ø–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ {DOWN_EMOJI}: {cover.date()} @ {cover_price:.2f} "
            f"(–¥–æ—Ö–æ–¥ ~ {pnl:.2f} USD)"
        )
        markers.append(
            {
                "side": "short",
                "sell": sell,
                "buy": cover,  # –ø–æ–∫—É–ø–∫–∞ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —à–æ—Ä—Ç–∞
                "sell_price": sell_price,
                "buy_price": cover_price,
                "pnl": pnl,
            }
        )

    return profit, lines, markers


def _build_position_text(delta_pct: float, long_profit: float, short_profit: float) -> str:
    """
    –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:
    - —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —É–∂–µ –¥–µ—Ä–∂–∏—à—å –∞–∫—Ç–∏–≤
    - —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ –ø–æ–∫–∞ –≤–Ω–µ –ø–æ–∑–∏—Ü–∏–∏

    –£—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â–∏–π —Ç—Ä–µ–Ω–¥ (delta_pct) –∏ —Ç–æ, –ø–æ –∫–∞–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
    –º–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç –±–æ–ª—å—à–µ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞ (long/short).
    """
    d = float(delta_pct)
    lp = float(long_profit or 0.0)
    sp = float(short_profit or 0.0)

    has_long_edge = lp > 0 and lp >= sp
    has_short_edge = sp > 0 and sp > lp

    tactical_note = ""
    if has_short_edge and d > 0:
        # –í —Ü–µ–ª–æ–º –∂–¥—ë–º —Ä–æ—Å—Ç, –Ω–æ –≤ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ–∫–µ –º–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç –∂–∏—Ä–Ω—ã–µ —à–æ—Ä—Ç—ã
        tactical_note = (
            "\n\n‚ö†Ô∏è –ü—Ä–∏ —ç—Ç–æ–º –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã —Å–µ–π—á–∞—Å –±–æ–ª—å—à–µ –≤ —Å—Ç–æ—Ä–æ–Ω—É —à–æ—Ä—Ç–∞ "
            "(—Ñ–∏–∫—Å–∞—Ü–∏—è/–∏–≥—Ä–∞ –Ω–∞ –æ—Ç–∫–∞—Ç–∞—Ö –ø–æ –ø—É—Ç–∏ –≤–≤–µ—Ä—Ö). –≠—Ç–æ —Å–ø–µ–∫—É–ª—è—Ç–∏–≤–Ω–∞—è —Ç–∞–∫—Ç–∏–∫–∞, "
            "–ø–æ–¥—Ö–æ–¥—è—â–∞—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π —á–∞—Å—Ç–∏ –∫–∞–ø–∏—Ç–∞–ª–∞, –∞ –Ω–µ –∑–∞–º–µ–Ω–∞ –±–∞–∑–æ–≤–æ–º—É "
            "—Å—Ü–µ–Ω–∞—Ä–∏—é –ø–æ –ø–æ–∑–∏—Ü–∏–∏."
        )
    elif has_long_edge and d < 0:
        # –í —Ü–µ–ª–æ–º —Ç—Ä–µ–Ω–¥ –≤–Ω–∏–∑, –Ω–æ –≤–Ω—É—Ç—Ä–∏ ‚Äî –ª–æ–Ω–≥–æ–≤—ã–µ –æ—Ç—Å–∫–æ–∫–∏
        tactical_note = (
            "\n\n‚ö†Ô∏è –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –º–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ –ª–æ–Ω–≥–æ–≤—ã–µ –æ—Ç—Å–∫–æ–∫–∏. "
            "–ò—Ö –ª–æ–≥–∏—á–Ω–µ–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∫–∞–∫ —Å–ø–µ–∫—É–ª—è—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ –Ω–∞ –¥–æ–ª—é –∫–∞–ø–∏—Ç–∞–ª–∞, "
            "–∞ –Ω–µ –∫–∞–∫ —Ä–∞–∑–≤–æ—Ä–æ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞."
        )

    # –°–∏–ª—å–Ω—ã–π –≤–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥
    if d >= POSITION_STRONG_TREND_PCT:
        return (
            "üìå –ë–∞–∑–æ–≤–∞—è –∏–¥–µ—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏:\n"
            f"‚Ä¢ –ï—Å–ª–∏ –≤—ã —É–∂–µ –¥–µ—Ä–∂–∏—Ç–µ –∞–∫—Ç–∏–≤ ‚Äî –º–æ–¥–µ–ª—å –∂–¥—ë—Ç –∑–∞–º–µ—Ç–Ω—ã–π —Ä–æ—Å—Ç (~{d:+.2f}% –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∞). "
            "–ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ–∫–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∏ –ø–æ –∂–µ–ª–∞–Ω–∏—é "
            "—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–±—ã–ª—å —á–∞—Å—Ç—è–º–∏ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ö–∞—è—Ö.\n"
            "‚Ä¢ –ï—Å–ª–∏ –≤—ã –≤–Ω–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–∫–∫—É—Ä–∞—Ç–Ω—É—é –ø–æ–∫—É–ø–∫—É –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏—è—Ö (–ª–æ–Ω–≥ –ø–æ —Ç—Ä–µ–Ω–¥—É) "
            "—Å —É–º–µ—Ä–µ–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º –ø–æ–∑–∏—Ü–∏–∏ –∏ –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–æ–ø–æ–º."
            f"{tactical_note}"
        )

    # –£–º–µ—Ä–µ–Ω–Ω—ã–π –≤–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥
    if POSITION_WEAK_TREND_PCT <= d < POSITION_STRONG_TREND_PCT:
        return (
            "üìå –ë–∞–∑–æ–≤–∞—è –∏–¥–µ—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏:\n"
            f"‚Ä¢ –ï—Å–ª–∏ –≤—ã —É–∂–µ –≤ –ª–æ–Ω–≥–µ ‚Äî –º–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç (~{d:+.2f}%). "
            "–°—Ü–µ–Ω–∞—Ä–∏–π ‚Äî –¥–µ—Ä–∂–∞—Ç—å –ø–æ–∑–∏—Ü–∏—é, –Ω–µ –Ω–∞—Ä–∞—â–∏–≤–∞—è –µ—ë –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ.\n"
            "‚Ä¢ –ï—Å–ª–∏ –≤—ã –≤–Ω–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–π –≤—Ö–æ–¥, –Ω–æ –∂–¥–∞—Ç—å "
            "–±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫—Ä—É–ø–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –æ–±—ä—ë–º–∞."
            f"{tactical_note}"
        )

    # –°–∏–ª—å–Ω—ã–π –Ω–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥
    if d <= -POSITION_STRONG_TREND_PCT:
        return (
            "üìå –ë–∞–∑–æ–≤–∞—è –∏–¥–µ—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏:\n"
            f"‚Ä¢ –ï—Å–ª–∏ –≤—ã —É–∂–µ –¥–µ—Ä–∂–∏—Ç–µ –∞–∫—Ç–∏–≤ ‚Äî –º–æ–¥–µ–ª—å –æ–∂–∏–¥–∞–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ (~{d:+.2f}%). "
            "–ë–∞–∑–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ –∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é, –Ω–µ —É—Å—Ä–µ–¥–Ω—è—Ç—å –ª–æ–Ω–≥ –±–µ–∑ —á—ë—Ç–∫–æ–≥–æ –ø–ª–∞–Ω–∞.\n"
            "‚Ä¢ –ï—Å–ª–∏ –≤—ã –≤–Ω–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –Ω–µ –≤—Ö–æ–¥–∏—Ç—å. "
            "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π ‚Äî —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —à–æ—Ä—Ç –ø–æ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º —Å–∏–≥–Ω–∞–ª–∞–º –ø—Ä–∏ –∂—ë—Å—Ç–∫–æ–º —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–µ."
            f"{tactical_note}"
        )

    # –£–º–µ—Ä–µ–Ω–Ω—ã–π –Ω–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥
    if -POSITION_STRONG_TREND_PCT < d <= -POSITION_WEAK_TREND_PCT:
        return (
            "üìå –ë–∞–∑–æ–≤–∞—è –∏–¥–µ—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏:\n"
            f"‚Ä¢ –ï—Å–ª–∏ –≤—ã —É–∂–µ –≤ –ª–æ–Ω–≥–µ ‚Äî –º–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç —É–º–µ—Ä–µ–Ω–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ (~{d:+.2f}%). "
            "–ú–æ–∂–Ω–æ —á–∞—Å—Ç–∏—á–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏–ª–∏ —É–∂–µ—Å—Ç–æ—á–∏—Ç—å —Å—Ç–æ–ø—ã.\n"
            "‚Ä¢ –ï—Å–ª–∏ –≤—ã –≤–Ω–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî —Å–∫–æ—Ä–µ–µ –≤—ã–∂–∏–¥–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è, —á–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏."
            f"{tactical_note}"
        )

    # –ë–æ–∫–æ–≤–∏–∫ / —Å–ª–∞–±—ã–π —Ç—Ä–µ–Ω–¥
    return (
        "üìå –ë–∞–∑–æ–≤–∞—è –∏–¥–µ—è –ø–æ –ø–æ–∑–∏—Ü–∏–∏:\n"
        "‚Ä¢ –ú–æ–¥–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞ ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ –±–µ–∑ —è—Ä–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –∏–ª–∏ –ø–∞–¥–µ–Ω–∏—è.\n"
        "‚Ä¢ –ï—Å–ª–∏ –≤—ã —É–∂–µ –≤ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –ª–æ–≥–∏—á–Ω–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è —Å–≤–æ–µ–π –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ "
        "(–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–ª–≥–æ—Å—Ä–æ–∫/—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞), –Ω–µ —Ä–µ–∞–≥–∏—Ä—É—è –Ω–∞ –º–µ–ª–∫–∏–µ –∫–æ–ª–µ–±–∞–Ω–∏—è.\n"
        "‚Ä¢ –ï—Å–ª–∏ –≤—ã –≤–Ω–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –æ—Å–Ω–æ–≤–∞–Ω–∏–π –¥–ª—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –∏–ª–∏ —Å—Ä–æ—á–Ω–æ–π –ø—Ä–æ–¥–∞–∂–∏ –ø–æ–∫–∞ –Ω–µ –≤–∏–¥–Ω–æ."
        f"{tactical_note}"
    )


# --------------------------------------------------------------------
# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
# --------------------------------------------------------------------

def generate_recommendations(fcst_df, capital_usd, model_rmse=None, baseline_price=None):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ—Ä–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Ü–µ–Ω.

    baseline_price ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è "–±–∞–∑–æ–≤–∞—è" —Ü–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—É—â–∏–π Close),
    –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ç–æ—Ä–æ–π —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–±—â–∏–π —Ç—Ä–µ–Ω–¥ delta_pct.
    """
    s = fcst_df["forecast"].astype(float)

    # –ë–∞–∑–æ–≤—ã–π sanity-check —Ä—è–¥–∞
    if s.isna().any() or (s <= 0).any():
        return (
            "–ü—Ä–æ–≥–Ω–æ–∑ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–æ–ª—å/NaN/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–Ω—ã). "
            "–°–∏–≥–Ω–∞–ª—ã –ø–æ –Ω–µ–º—É –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–µ –±—É–¥—É.",
            0.0,
            [],
        )

    mins, maxs = _local_extrema(s)

    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: —Ç–æ–ª—å–∫–æ –ª–æ–Ω–≥
    long_profit, long_lines, long_markers = _build_long_trades(
        s, mins, maxs, capital_usd, model_rmse
    )

    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: —Ç–æ–ª—å–∫–æ —à–æ—Ä—Ç
    short_profit, short_lines, short_markers = _build_short_trades(
        s, mins, maxs, capital_usd, model_rmse
    )

    all_markers = long_markers + short_markers

    # –û–±—â–∏–π "–Ω–∞–∫–ª–æ–Ω" –ø—Ä–æ–≥–Ω–æ–∑–∞ ‚Äî –æ—Ç baseline –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏
    try:
        last_price = float(s.iloc[-1])

        if baseline_price is not None and baseline_price > 0:
            first_price = float(baseline_price)
        else:
            first_price = float(s.iloc[0])

        if first_price > 0:
            delta_pct = (last_price - first_price) / first_price * 100.0
        else:
            delta_pct = 0.0
    except Exception:
        delta_pct = 0.0

    # –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å —É—á—ë—Ç–æ–º —Ç—Ä–µ–Ω–¥–∞ –∏ —Ç–æ–≥–æ, –≥–¥–µ –±–æ–ª—å—à–µ –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏—Ç–∞
    position_text = _build_position_text(delta_pct, long_profit, short_profit)

    # --- –Ω–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫ ---
    if not long_lines and not short_lines:
        # –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫, –Ω–æ —Ç—Ä–µ–Ω–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏–ª—å–Ω—ã–º –∏–ª–∏ —Å–ª–∞–±—ã–º
        if abs(delta_pct) >= TREND_ALERT_PCT:
            direction = "—Ä–æ—Å—Ç" if delta_pct > 0 else "—Å–Ω–∏–∂–µ–Ω–∏–µ"
            summary = (
                f"–ú–æ–¥–µ–ª—å –æ–∂–∏–¥–∞–µ—Ç –≤—ã—Ä–∞–∂–µ–Ω–Ω—ã–π {direction} —Ü–µ–Ω—ã (~{delta_pct:+.2f}% –∑–∞ –ø–µ—Ä–∏–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∞), "
                "–Ω–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–º–∏–Ω–∏–º—É–º—ã/–º–∞–∫—Å–∏–º—É–º—ã) –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç "
                "—Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –æ–∂–∏–¥–∞–µ–º–æ–π –ø—Ä–∏–±—ã–ª–∏ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ (RMSE).\n\n"
                "–§–æ—Ä–º–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ –Ω–µ—Ç, "
                "–ø–æ—ç—Ç–æ–º—É –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –∏–º–µ–Ω–Ω–æ –Ω–∞ –æ–±—â–∏–π —Ç—Ä–µ–Ω–¥ –∏ –≤–∞—à—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—é.\n\n"
                f"{position_text}"
            )
        else:
            summary = (
                "–ü–æ –ø—Ä–æ–≥–Ω–æ–∑—É –Ω–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∏–ª—å–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∏ –¥–ª—è –ª–æ–Ω–≥–∞, "
                "–Ω–∏ –¥–ª—è —à–æ—Ä—Ç–∞ (–º–µ–ª–∫–∏–µ —Å–∏–≥–Ω–∞–ª—ã –±—ã–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –ø–æ –ø–æ—Ä–æ–≥—É –ø—Ä–∏–±—ã–ª–∏/RMSE).\n\n"
                f"{position_text}"
            )
        est_profit = 0.0

    # --- –µ—Å—Ç—å —Å–¥–µ–ª–∫–∏ ---
    else:
        parts = []
        if long_lines:
            parts.append(
                "–°—Ü–µ–Ω–∞—Ä–∏–π 1 ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–Ω–≥ (–ø–æ–∫—É–ø–∫–∞ –Ω–∞ –º–∏–Ω–∏–º—É–º–∞—Ö, –ø—Ä–æ–¥–∞–∂–∞ –Ω–∞ –º–∞–∫—Å–∏–º—É–º–∞—Ö):\n"
                + "\n".join(long_lines)
                + f"\n–ò—Ç–æ–≥–æ –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥ (–ª–æ–Ω–≥): ~{long_profit:.2f} USD"
            )
        if short_lines:
            parts.append(
                "–°—Ü–µ–Ω–∞—Ä–∏–π 2 ‚Äî —Ç–æ–ª—å–∫–æ —à–æ—Ä—Ç (–ø—Ä–æ–¥–∞–∂–∞ –Ω–∞ –º–∞–∫—Å–∏–º—É–º–∞—Ö, –∑–∞–∫—Ä—ã—Ç–∏–µ –Ω–∞ –º–∏–Ω–∏–º—É–º–∞—Ö):\n"
                + "\n".join(short_lines)
                + f"\n–ò—Ç–æ–≥–æ –æ–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥ (—à–æ—Ä—Ç): ~{short_profit:.2f} USD"
            )

        # –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ–≤–µ—Ä—Ö —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
        parts.append(position_text)

        summary = "\n\n".join(parts)
        est_profit = float(max(long_profit, short_profit))

    return summary, est_profit, all_markers
